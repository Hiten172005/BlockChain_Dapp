<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Credit System Dashboard</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/ethers/6.7.0/ethers.umd.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
        }

        .header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .header h1 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .wallet-info {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 15px;
        }

        .wallet-address {
            font-family: monospace;
            background: #f0f0f0;
            padding: 10px 15px;
            border-radius: 8px;
            font-size: 14px;
        }

        button {
            background: #667eea;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: 600;
            transition: all 0.3s;
        }

        button:hover {
            background: #5568d3;
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.4);
        }

        button:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        .contracts-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 25px;
            margin-bottom: 30px;
        }

        .contract-card {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .contract-card h2 {
            color: #667eea;
            margin-bottom: 20px;
            font-size: 20px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        .form-group label {
            display: block;
            margin-bottom: 5px;
            font-weight: 600;
            color: #333;
        }

        .form-group input,
        .form-group textarea {
            width: 100%;
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 14px;
            transition: border-color 0.3s;
        }

        .form-group input:focus,
        .form-group textarea:focus {
            outline: none;
            border-color: #667eea;
        }

        .form-group textarea {
            resize: vertical;
            min-height: 80px;
        }

        .status-message {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-size: 14px;
            display: none;
        }

        .status-message.success {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }

        .status-message.error {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }

        .status-message.info {
            background: #d1ecf1;
            color: #0c5460;
            border: 1px solid #bee5eb;
        }

        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
        }

        .btn-group button {
            flex: 1;
        }

        .output-section {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-top: 30px;
        }

        .output-section h2 {
            color: #667eea;
            margin-bottom: 20px;
        }

        .output-content {
            background: #f8f9fa;
            padding: 20px;
            border-radius: 8px;
            font-family: monospace;
            font-size: 14px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
            word-break: break-all;
        }

        .contract-addresses {
            background: white;
            padding: 25px;
            border-radius: 15px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
            margin-bottom: 30px;
        }

        .contract-addresses h2 {
            color: #667eea;
            margin-bottom: 15px;
        }

        .address-item {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
            margin-bottom: 10px;
        }

        .address-label {
            font-weight: 600;
            color: #333;
        }

        .address-value {
            font-family: monospace;
            font-size: 12px;
            color: #666;
        }

        .info-box {
            background: #e7f3ff;
            border-left: 4px solid #2196F3;
            padding: 15px;
            margin-bottom: 15px;
            border-radius: 5px;
        }

        .info-box p {
            margin: 5px 0;
            font-size: 14px;
            color: #0c5460;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>üè¶ Credit System Dashboard</h1>
            <div class="wallet-info">
                <div id="walletStatus">
                    <button id="connectWallet">Connect MetaMask</button>
                </div>
            </div>
        </div>

        <div class="contract-addresses">
            <h2>üìã Deployed Contract Addresses</h2>
            <div class="address-item">
                <span class="address-label">BankRegistry:</span>
                <span class="address-value" id="bankRegistryAddr">Not set</span>
            </div>
            <div class="address-item">
                <span class="address-label">CreditDataLedger:</span>
                <span class="address-value" id="creditDataAddr">Not set</span>
            </div>
            <div class="address-item">
                <span class="address-label">FraudReportLedger:</span>
                <span class="address-value" id="fraudReportAddr">Not set</span>
            </div>
            <button onclick="updateContractAddresses()" style="margin-top: 10px;">Update Addresses</button>
        </div>

        <div class="contracts-grid">
            <!-- Bank Registry Card -->
            <div class="contract-card">
                <h2>üèõÔ∏è Bank Registry</h2>
                <div class="info-box">
                    <p><strong>Note:</strong> Only the contract owner can register banks.</p>
                    <p>Your address: <span id="currentAddr" style="font-family: monospace; font-size: 12px;">Not connected</span></p>
                </div>
                <div class="form-group">
                    <label>Bank Address to Register:</label>
                    <input type="text" id="bankAddr" placeholder="0x...">
                </div>
                <div class="btn-group">
                    <button onclick="registerBank()">Register Bank</button>
                    <button onclick="checkBankStatus()">Check Status</button>
                </div>
                <div id="bankStatus" class="status-message"></div>
            </div>

            <!-- Credit Data Ledger Card -->
            <div class="contract-card">
                <h2>üí≥ Credit Data Ledger</h2>
                <div class="info-box">
                    <p><strong>Note:</strong> Only registered banks can add entries.</p>
                </div>
                <div class="form-group">
                    <label>Customer Address:</label>
                    <input type="text" id="customerAddr" placeholder="0x...">
                </div>
                <div class="form-group">
                    <label>Entry Details:</label>
                    <textarea id="entryDetails" placeholder="e.g., Loan Repayment Successful: ID 987"></textarea>
                </div>
                <div class="btn-group">
                    <button onclick="addCreditEntry()">Add Credit Entry</button>
                    <button onclick="getCreditHistory()">Get History</button>
                </div>
                <div id="creditStatus" class="status-message"></div>
            </div>

            <!-- Fraud Report Ledger Card -->
            <div class="contract-card">
                <h2>‚ö†Ô∏è Fraud Report Ledger</h2>
                <div class="info-box">
                    <p><strong>Note:</strong> Only registered banks can submit reports.</p>
                </div>
                <div class="form-group">
                    <label>Customer Address:</label>
                    <input type="text" id="fraudCustomerAddr" placeholder="0x...">
                </div>
                <div class="form-group">
                    <label>Report Details:</label>
                    <textarea id="reportDetails" placeholder="Describe the fraud incident"></textarea>
                </div>
                <div class="btn-group">
                    <button onclick="submitReport()">Submit Report</button>
                    <button onclick="getReports()">Get Reports</button>
                </div>
                <div id="fraudStatus" class="status-message"></div>
            </div>
        </div>

        <div class="output-section">
            <h2>üìä Output & Results</h2>
            <div class="output-content" id="output">
                Connect your wallet to start interacting with the contracts...
            </div>
        </div>
    </div>

    <script>
        // Contract addresses - UPDATE THESE WITH YOUR DEPLOYED ADDRESSES
        let CONTRACT_ADDRESSES = {
            bankRegistry: '0x5FbDB2315678afecb367f032d93F642f64180aa3',
            creditDataLedger: '0xe7f1725E7734CE288F8367e1Bb143E90bb3F0512',
            fraudReportLedger: '0x9fE46736679d2D9a65F0992F2272dE9f3c7fa6e0'
        };

        // Contract ABIs matching your actual contracts
        const BANK_REGISTRY_ABI = [
            "function registerBank(address _bankAddress) external",
            "function removeBank(address _bankAddress) external",
            "function isBankRegistered(address _bankAddress) external view returns (bool)",
            "function owner() external view returns (address)",
            "event BankRegistered(address indexed bankAddress)",
            "event BankRemoved(address indexed bankAddress)"
        ];

        const CREDIT_DATA_ABI = [
            "function addCreditEntry(address _userAddress, string memory _entryDetails) external",
            "function getUserCreditHistory(address _userAddress) external view returns (tuple(uint256 entryId, string entryDetails, address reportingBank, uint256 timestamp)[])",
            "function bankRegistryAddress() external view returns (address)",
            "function entryCounter() external view returns (uint256)",
            "event CreditDataAdded(address indexed userAddress, address indexed bankAddress, uint256 entryId)"
        ];

        const FRAUD_REPORT_ABI = [
            "function submitReport(address _customerAddress, string memory _reportDetails) external",
            "function getReportsForCustomer(address _customerAddress) external view returns (tuple(uint256 reportId, address customerAddress, string reportDetails, address reportingBank, uint256 timestamp)[])",
            "function reports(uint256) external view returns (uint256 reportId, address customerAddress, string reportDetails, address reportingBank, uint256 timestamp)",
            "function reportCounter() external view returns (uint256)",
            "event ReportSubmitted(uint256 indexed reportId, address indexed customerAddress, address indexed bankAddress)"
        ];

        let provider;
        let signer;
        let bankRegistryContract;
        let creditDataContract;
        let fraudReportContract;
        let userAddress;

        // Update displayed addresses
        function updateDisplayedAddresses() {
            document.getElementById('bankRegistryAddr').textContent = CONTRACT_ADDRESSES.bankRegistry;
            document.getElementById('creditDataAddr').textContent = CONTRACT_ADDRESSES.creditDataLedger;
            document.getElementById('fraudReportAddr').textContent = CONTRACT_ADDRESSES.fraudReportLedger;
        }

        // Function to update contract addresses
        function updateContractAddresses() {
            const newBankRegistry = prompt('Enter BankRegistry address:', CONTRACT_ADDRESSES.bankRegistry);
            const newCreditData = prompt('Enter CreditDataLedger address:', CONTRACT_ADDRESSES.creditDataLedger);
            const newFraudReport = prompt('Enter FraudReportLedger address:', CONTRACT_ADDRESSES.fraudReportLedger);

            if (newBankRegistry) CONTRACT_ADDRESSES.bankRegistry = newBankRegistry;
            if (newCreditData) CONTRACT_ADDRESSES.creditDataLedger = newCreditData;
            if (newFraudReport) CONTRACT_ADDRESSES.fraudReportLedger = newFraudReport;

            updateDisplayedAddresses();
            
            if (provider && signer) {
                initializeContracts();
            }
            
            showOutput('Contract addresses updated successfully!', 'success');
        }

        // Initialize displayed addresses
        updateDisplayedAddresses();

        // Connect wallet
        document.getElementById('connectWallet').addEventListener('click', async () => {
            try {
                if (typeof window.ethereum === 'undefined') {
                    alert('Please install MetaMask!');
                    return;
                }

                const accounts = await window.ethereum.request({ method: 'eth_requestAccounts' });
                userAddress = accounts[0];

                provider = new ethers.BrowserProvider(window.ethereum);
                signer = await provider.getSigner();

                initializeContracts();

                document.getElementById('walletStatus').innerHTML = `
                    <div class="wallet-address">Connected: ${userAddress.substring(0, 6)}...${userAddress.substring(38)}</div>
                `;

                document.getElementById('currentAddr').textContent = userAddress;

                showOutput(`‚úÖ Wallet connected successfully!\nAddress: ${userAddress}`, 'success');
            } catch (error) {
                console.error('Error connecting wallet:', error);
                showOutput(`‚ùå Error connecting wallet: ${error.message}`, 'error');
            }
        });

        function initializeContracts() {
            bankRegistryContract = new ethers.Contract(CONTRACT_ADDRESSES.bankRegistry, BANK_REGISTRY_ABI, signer);
            creditDataContract = new ethers.Contract(CONTRACT_ADDRESSES.creditDataLedger, CREDIT_DATA_ABI, signer);
            fraudReportContract = new ethers.Contract(CONTRACT_ADDRESSES.fraudReportLedger, FRAUD_REPORT_ABI, signer);
        }

        function showStatus(elementId, message, type) {
            const statusEl = document.getElementById(elementId);
            statusEl.textContent = message;
            statusEl.className = `status-message ${type}`;
            statusEl.style.display = 'block';
            setTimeout(() => {
                statusEl.style.display = 'none';
            }, 5000);
        }

        function showOutput(message, type = 'info') {
            const outputEl = document.getElementById('output');
            const timestamp = new Date().toLocaleTimeString();
            outputEl.textContent = `[${timestamp}] ${message}\n\n` + outputEl.textContent;
        }

        // Bank Registry Functions
        async function registerBank() {
            const bankAddr = document.getElementById('bankAddr').value;

            if (!bankAddr) {
                showStatus('bankStatus', 'Please enter bank address', 'error');
                return;
            }

            try {
                showStatus('bankStatus', 'Registering bank...', 'info');
                const tx = await bankRegistryContract.registerBank(bankAddr);
                showOutput(`‚è≥ Transaction submitted: ${tx.hash}`, 'info');
                
                await tx.wait();
                showStatus('bankStatus', 'Bank registered successfully!', 'success');
                showOutput(`‚úÖ Bank registered successfully!\nAddress: ${bankAddr}`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('bankStatus', `Error: ${error.message}`, 'error');
                showOutput(`‚ùå Error registering bank: ${error.message}`, 'error');
            }
        }

        async function checkBankStatus() {
            const bankAddr = document.getElementById('bankAddr').value || userAddress;

            if (!bankAddr) {
                showStatus('bankStatus', 'Please enter bank address', 'error');
                return;
            }

            try {
                showStatus('bankStatus', 'Checking bank status...', 'info');
                const isRegistered = await bankRegistryContract.isBankRegistered(bankAddr);
                
                const output = `
Bank Status for ${bankAddr}:
‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ
Registered: ${isRegistered ? 'YES ‚úÖ' : 'NO ‚ùå'}
                `.trim();
                
                showStatus('bankStatus', isRegistered ? 'Bank is registered!' : 'Bank is NOT registered', isRegistered ? 'success' : 'error');
                showOutput(output, 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('bankStatus', `Error: ${error.message}`, 'error');
                showOutput(`‚ùå Error checking bank status: ${error.message}`, 'error');
            }
        }

        // Credit Data Functions
        async function addCreditEntry() {
            const customerAddr = document.getElementById('customerAddr').value;
            const entryDetails = document.getElementById('entryDetails').value;

            if (!customerAddr || !entryDetails) {
                showStatus('creditStatus', 'Please fill in all fields', 'error');
                return;
            }

            try {
                showStatus('creditStatus', 'Adding credit entry...', 'info');
                const tx = await creditDataContract.addCreditEntry(customerAddr, entryDetails);
                showOutput(`‚è≥ Transaction submitted: ${tx.hash}`, 'info');
                
                await tx.wait();
                showStatus('creditStatus', 'Credit entry added successfully!', 'success');
                showOutput(`‚úÖ Credit entry added!\nCustomer: ${customerAddr}\nDetails: ${entryDetails}`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('creditStatus', `Error: ${error.message}`, 'error');
                showOutput(`‚ùå Error adding credit entry: ${error.message}`, 'error');
            }
        }

        async function getCreditHistory() {
            const customerAddr = document.getElementById('customerAddr').value;

            if (!customerAddr) {
                showStatus('creditStatus', 'Please enter customer address', 'error');
                return;
            }

            try {
                showStatus('creditStatus', 'Fetching credit history...', 'info');
                const history = await creditDataContract.getUserCreditHistory(customerAddr);
                
                if (history.length === 0) {
                    showOutput(`No credit history found for ${customerAddr}`, 'info');
                    showStatus('creditStatus', 'No history found', 'info');
                    return;
                }

                let output = `Credit History for ${customerAddr}:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                history.forEach((entry, index) => {
                    output += `Entry #${index + 1} (ID: ${entry.entryId}):\n`;
                    output += `Details: ${entry.entryDetails}\n`;
                    output += `Reporting Bank: ${entry.reportingBank}\n`;
                    output += `Time: ${new Date(Number(entry.timestamp) * 1000).toLocaleString()}\n\n`;
                });
                
                showStatus('creditStatus', `Found ${history.length} entry(ies)`, 'success');
                showOutput(output, 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('creditStatus', `Error: ${error.message}`, 'error');
                showOutput(`‚ùå Error fetching credit history: ${error.message}`, 'error');
            }
        }

        // Fraud Report Functions
        async function submitReport() {
            const customerAddr = document.getElementById('fraudCustomerAddr').value;
            const reportDetails = document.getElementById('reportDetails').value;

            if (!customerAddr || !reportDetails) {
                showStatus('fraudStatus', 'Please fill in all fields', 'error');
                return;
            }

            try {
                showStatus('fraudStatus', 'Submitting fraud report...', 'info');
                const tx = await fraudReportContract.submitReport(customerAddr, reportDetails);
                showOutput(`‚è≥ Transaction submitted: ${tx.hash}`, 'info');
                
                await tx.wait();
                showStatus('fraudStatus', 'Fraud report submitted successfully!', 'success');
                showOutput(`‚úÖ Fraud report submitted!\nCustomer: ${customerAddr}\nDetails: ${reportDetails}`, 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('fraudStatus', `Error: ${error.message}`, 'error');
                showOutput(`‚ùå Error submitting report: ${error.message}`, 'error');
            }
        }

        async function getReports() {
            const customerAddr = document.getElementById('fraudCustomerAddr').value;

            if (!customerAddr) {
                showStatus('fraudStatus', 'Please enter customer address', 'error');
                return;
            }

            try {
                showStatus('fraudStatus', 'Fetching fraud reports...', 'info');
                const reports = await fraudReportContract.getReportsForCustomer(customerAddr);
                
                if (reports.length === 0) {
                    showOutput(`No fraud reports found for ${customerAddr}`, 'info');
                    showStatus('fraudStatus', 'No reports found', 'info');
                    return;
                }

                let output = `Fraud Reports for ${customerAddr}:\n‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ‚îÅ\n\n`;
                reports.forEach((report, index) => {
                    output += `Report #${index + 1} (ID: ${report.reportId}):\n`;
                    output += `Customer: ${report.customerAddress}\n`;
                    output += `Details: ${report.reportDetails}\n`;
                    output += `Reporting Bank: ${report.reportingBank}\n`;
                    output += `Time: ${new Date(Number(report.timestamp) * 1000).toLocaleString()}\n\n`;
                });
                
                showStatus('fraudStatus', `Found ${reports.length} report(s)`, 'success');
                showOutput(output, 'success');
            } catch (error) {
                console.error('Error:', error);
                showStatus('fraudStatus', `Error: ${error.message}`, 'error');
                showOutput(`‚ùå Error fetching fraud reports: ${error.message}`, 'error');
            }
        }
    </script>
</body>
</html>